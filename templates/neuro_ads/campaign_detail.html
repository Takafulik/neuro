{% extends 'base.html' %}
{% load static %}

{% block title %}{{ campaign.name }} - Campaign Details{% endblock %}

{% block extra_head %}
<style>
    .campaign-header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border-radius: 15px;
        padding: 2rem;
        margin-bottom: 2rem;
    }
    
    .status-badge {
        padding: 0.5rem 1rem;
        border-radius: 20px;
        font-weight: bold;
        text-transform: uppercase;
        font-size: 0.8rem;
    }
    
    .status-active { background: #d4edda; color: #155724; }
    .status-paused { background: #fff3cd; color: #856404; }
    .status-draft { background: #e2e3e5; color: #383d41; }
    .status-completed { background: #cce7ff; color: #004085; }
    
    .ai-indicator {
        background: linear-gradient(45deg, #ff6b6b, #ee5a24);
        color: white;
        padding: 0.3rem 0.8rem;
        border-radius: 15px;
        font-size: 0.7rem;
        font-weight: bold;
        animation: pulse 2s infinite;
    }
    
    @keyframes pulse {
        0% { transform: scale(1); }
        50% { transform: scale(1.05); }
        100% { transform: scale(1); }
    }
    
    .metric-card {
        border: none;
        border-radius: 15px;
        box-shadow: 0 0.15rem 1.75rem 0 rgba(58, 59, 69, 0.15);
        transition: all 0.3s ease;
    }
    
    .metric-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 0.25rem 2rem 0 rgba(58, 59, 69, 0.25);
    }
    
    .platform-tab {
        border: 2px solid #e3e6f0;
        border-radius: 10px;
        padding: 1rem;
        margin-bottom: 1rem;
        cursor: pointer;
        transition: all 0.3s ease;
    }
    
    .platform-tab.active {
        border-color: #4e73df;
        background: #f8f9fc;
    }
    
    .creative-preview {
        border: 1px solid #e3e6f0;
        border-radius: 10px;
        padding: 1rem;
        margin-bottom: 1rem;
        background: #f8f9fc;
    }
    
    .optimization-alert {
        border-left: 4px solid #1cc88a;
        background: #d4edda;
        padding: 1rem;
        border-radius: 5px;
        margin-bottom: 1rem;
    }
    
    .progress-bar-animated {
        animation: progress-bar-stripes 1s linear infinite;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    
    <!-- Campaign Header -->
    <div class="campaign-header">
        <div class="row align-items-center">
            <div class="col-md-8">
                <div class="d-flex align-items-center mb-2">
                    <h1 class="h3 mb-0 mr-3">{{ campaign.name }}</h1>
                    {% if campaign.is_ai_generated %}
                    <span class="ai-indicator">
                        <i class="fas fa-robot mr-1"></i>AI POWERED
                    </span>
                    {% endif %}
                </div>
                <p class="mb-2">{{ campaign.description }}</p>
                <div class="d-flex align-items-center">
                    <span class="status-badge status-{{ campaign.status|lower }} mr-3">
                        {{ campaign.get_status_display }}
                    </span>
                    <span class="mr-3">
                        <i class="fas fa-calendar mr-1"></i>
                        {{ campaign.start_date|date:"M d, Y" }} - {{ campaign.end_date|date:"M d, Y" }}
                    </span>
                    <span>
                        <i class="fas fa-dollar-sign mr-1"></i>
                        Budget: ${{ campaign.total_budget|floatformat:0 }}
                    </span>
                </div>
            </div>
            <div class="col-md-4 text-right">
                <div class="btn-group" role="group">
                    {% if campaign.status == 'active' %}
                    <button class="btn btn-warning" onclick="pauseCampaign()">
                        <i class="fas fa-pause mr-1"></i>Pause
                    </button>
                    {% elif campaign.status == 'paused' %}
                    <button class="btn btn-success" onclick="resumeCampaign()">
                        <i class="fas fa-play mr-1"></i>Resume
                    </button>
                    {% endif %}
                    <button class="btn btn-primary" onclick="optimizeCampaign()">
                        <i class="fas fa-magic mr-1"></i>AI Optimize
                    </button>
                    <div class="btn-group" role="group">
                        <button class="btn btn-secondary dropdown-toggle" data-toggle="dropdown">
                            <i class="fas fa-cog"></i>
                        </button>
                        <div class="dropdown-menu">
                            <a class="dropdown-item" href="{% url 'neuro_ads:edit_campaign' campaign.id %}">
                                <i class="fas fa-edit mr-2"></i>Edit Campaign
                            </a>
                            <a class="dropdown-item" href="{% url 'neuro_ads:duplicate_campaign' campaign.id %}">
                                <i class="fas fa-copy mr-2"></i>Duplicate
                            </a>
                            <div class="dropdown-divider"></div>
                            <a class="dropdown-item text-danger" href="#" onclick="deleteCampaign()">
                                <i class="fas fa-trash mr-2"></i>Delete
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- AI Optimizations Alert -->
    {% if recent_optimizations %}
    <div class="optimization-alert">
        <h6 class="text-success mb-2">
            <i class="fas fa-brain mr-2"></i>
            Recent AI Optimizations
        </h6>
        {% for opt in recent_optimizations %}
        <div class="small mb-1">
            <strong>{{ opt.created_at|timesince }} ago:</strong> {{ opt.description }}
            {% if opt.improvement_percentage %}
            <span class="text-success">
                (+{{ opt.improvement_percentage|floatformat:1 }}% improvement)
            </span>
            {% endif %}
        </div>
        {% endfor %}
    </div>
    {% endif %}

    <!-- Performance Metrics -->
    <div class="row mb-4">
        <div class="col-xl-3 col-md-6">
            <div class="card metric-card border-left-primary h-100 py-2">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-primary text-uppercase mb-1">
                                Total Spend
                            </div>
                            <div class="h5 mb-0 font-weight-bold text-gray-800">
                                ${{ analytics.total_spend|floatformat:2 }}
                            </div>
                            <div class="small text-success">
                                <i class="fas fa-arrow-up mr-1"></i>
                                {{ analytics.spend_change|floatformat:1 }}% vs last period
                            </div>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-dollar-sign fa-2x text-gray-300"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-xl-3 col-md-6">
            <div class="card metric-card border-left-success h-100 py-2">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-success text-uppercase mb-1">
                                Revenue
                            </div>
                            <div class="h5 mb-0 font-weight-bold text-gray-800">
                                ${{ analytics.revenue|floatformat:2 }}
                            </div>
                            <div class="small text-success">
                                <i class="fas fa-arrow-up mr-1"></i>
                                {{ analytics.revenue_change|floatformat:1 }}% vs last period
                            </div>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-chart-line fa-2x text-gray-300"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-xl-3 col-md-6">
            <div class="card metric-card border-left-info h-100 py-2">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-info text-uppercase mb-1">
                                ROAS
                            </div>
                            <div class="h5 mb-0 font-weight-bold text-gray-800">
                                {{ analytics.roas|floatformat:2 }}x
                            </div>
                            <div class="small {% if analytics.roas_change > 0 %}text-success{% else %}text-danger{% endif %}">
                                <i class="fas fa-arrow-{% if analytics.roas_change > 0 %}up{% else %}down{% endif %} mr-1"></i>
                                {{ analytics.roas_change|floatformat:1 }}% vs last period
                            </div>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-percentage fa-2x text-gray-300"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-xl-3 col-md-6">
            <div class="card metric-card border-left-warning h-100 py-2">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-warning text-uppercase mb-1">
                                Conversions
                            </div>
                            <div class="h5 mb-0 font-weight-bold text-gray-800">
                                {{ analytics.conversions|floatformat:0 }}
                            </div>
                            <div class="small text-success">
                                <i class="fas fa-arrow-up mr-1"></i>
                                {{ analytics.conversion_change|floatformat:1 }}% vs last period
                            </div>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-bullseye fa-2x text-gray-300"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Platform Performance -->
    <div class="row">
        <div class="col-lg-8">
            <div class="card">
                <div class="card-header">
                    <h6 class="m-0 font-weight-bold text-primary">
                        <i class="fas fa-chart-bar mr-2"></i>
                        Platform Performance
                    </h6>
                </div>
                <div class="card-body">
                    <div class="chart-area">
                        <canvas id="performanceChart"></canvas>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-lg-4">
            <div class="card">
                <div class="card-header">
                    <h6 class="m-0 font-weight-bold text-primary">
                        <i class="fas fa-network-wired mr-2"></i>
                        Platform Breakdown
                    </h6>
                </div>
                <div class="card-body">
                    {% for platform_data in platform_analytics %}
                    <div class="platform-tab">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                {% if platform_data.platform == 'google' %}
                                    <i class="fab fa-google text-danger mr-2"></i>Google Ads
                                {% elif platform_data.platform == 'meta' %}
                                    <i class="fab fa-facebook text-primary mr-2"></i>Meta Ads
                                {% elif platform_data.platform == 'linkedin' %}
                                    <i class="fab fa-linkedin text-info mr-2"></i>LinkedIn Ads
                                {% endif %}
                            </div>
                            <div class="text-right">
                                <div class="font-weight-bold">${{ platform_data.spend|floatformat:0 }}</div>
                                <div class="small text-muted">{{ platform_data.roas|floatformat:2 }}x ROAS</div>
                            </div>
                        </div>
                        <div class="progress mt-2" style="height: 5px;">
                            <div class="progress-bar bg-primary" style="width: {{ platform_data.budget_percentage }}%"></div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>

    <!-- Ad Sets & Creatives -->
    <div class="row mt-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <div class="d-flex justify-content-between align-items-center">
                        <h6 class="m-0 font-weight-bold text-primary">
                            <i class="fas fa-images mr-2"></i>
                            Ad Sets & Creatives
                        </h6>
                        <button class="btn btn-sm btn-primary" onclick="generateNewCreatives()">
                            <i class="fas fa-magic mr-1"></i>AI Generate New
                        </button>
                    </div>
                </div>
                <div class="card-body">
                    <div class="row">
                        {% for adset in campaign.adsets.all %}
                        <div class="col-lg-6 mb-3">
                            <div class="card h-100">
                                <div class="card-header py-2">
                                    <div class="d-flex justify-content-between align-items-center">
                                        <h6 class="mb-0">{{ adset.name }}</h6>
                                        <span class="badge badge-{% if adset.status == 'active' %}success{% else %}secondary{% endif %}">
                                            {{ adset.get_status_display }}
                                        </span>
                                    </div>
                                </div>
                                <div class="card-body p-3">
                                    {% for creative in adset.creatives.all %}
                                    <div class="creative-preview mb-2">
                                        <div class="d-flex justify-content-between align-items-start">
                                            <div class="flex-grow-1">
                                                <div class="font-weight-bold mb-1">{{ creative.headline }}</div>
                                                <div class="small text-muted mb-2">{{ creative.description|truncatewords:15 }}</div>
                                                <div class="d-flex justify-content-between small">
                                                    <span>CTR: {{ creative.analytics.ctr|floatformat:2 }}%</span>
                                                    <span>CVR: {{ creative.analytics.cvr|floatformat:2 }}%</span>
                                                    <span>CPC: ${{ creative.analytics.cpc|floatformat:2 }}</span>
                                                </div>
                                            </div>
                                            {% if creative.is_ai_generated %}
                                            <span class="badge badge-danger ml-2">AI</span>
                                            {% endif %}
                                        </div>
                                        
                                        <!-- A/B Test Indicator -->
                                        {% if creative.ab_tests.exists %}
                                        <div class="mt-2 p-2 bg-info text-white rounded">
                                            <small>
                                                <i class="fas fa-vials mr-1"></i>
                                                A/B Testing: {{ creative.ab_tests.count }} variant(s)
                                            </small>
                                        </div>
                                        {% endif %}
                                    </div>
                                    {% endfor %}
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- A/B Tests -->
    {% if ab_tests %}
    <div class="row mt-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h6 class="m-0 font-weight-bold text-primary">
                        <i class="fas fa-vials mr-2"></i>
                        Active A/B Tests
                    </h6>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>Test Name</th>
                                    <th>Status</th>
                                    <th>Variants</th>
                                    <th>Winner</th>
                                    <th>Confidence</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for test in ab_tests %}
                                <tr>
                                    <td>{{ test.name }}</td>
                                    <td>
                                        <span class="badge badge-{% if test.status == 'running' %}primary{% elif test.status == 'completed' %}success{% else %}secondary{% endif %}">
                                            {{ test.get_status_display }}
                                        </span>
                                    </td>
                                    <td>{{ test.variants.count }}</td>
                                    <td>
                                        {% if test.winning_variant %}
                                            {{ test.winning_variant.name }}
                                        {% else %}
                                            <span class="text-muted">TBD</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if test.confidence_level %}
                                            {{ test.confidence_level|floatformat:1 }}%
                                        {% else %}
                                            <span class="text-muted">Collecting data...</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        <a href="{% url 'neuro_ads:ab_test_detail' test.id %}" class="btn btn-sm btn-outline-primary">
                                            View Details
                                        </a>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endif %}
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
// Performance Chart
const ctx = document.getElementById('performanceChart').getContext('2d');
const performanceChart = new Chart(ctx, {
    type: 'line',
    data: {
        labels: {{ chart_labels|safe }},
        datasets: [
            {
                label: 'Spend',
                data: {{ spend_data|safe }},
                borderColor: '#4e73df',
                backgroundColor: 'rgba(78, 115, 223, 0.1)',
                yAxisID: 'y'
            },
            {
                label: 'Revenue',
                data: {{ revenue_data|safe }},
                borderColor: '#1cc88a',
                backgroundColor: 'rgba(28, 200, 138, 0.1)',
                yAxisID: 'y'
            },
            {
                label: 'ROAS',
                data: {{ roas_data|safe }},
                borderColor: '#36b9cc',
                backgroundColor: 'rgba(54, 185, 204, 0.1)',
                yAxisID: 'y1'
            }
        ]
    },
    options: {
        responsive: true,
        scales: {
            y: {
                type: 'linear',
                display: true,
                position: 'left',
                title: {
                    display: true,
                    text: 'Amount ($)'
                }
            },
            y1: {
                type: 'linear',
                display: true,
                position: 'right',
                title: {
                    display: true,
                    text: 'ROAS'
                },
                grid: {
                    drawOnChartArea: false,
                }
            }
        }
    }
});

// Campaign Actions
function pauseCampaign() {
    if (confirm('Are you sure you want to pause this campaign?')) {
        fetch('{% url "neuro_ads:pause_campaign" campaign.id %}', {
            method: 'POST',
            headers: {
                'X-CSRFToken': '{{ csrf_token }}',
                'Content-Type': 'application/json'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                location.reload();
            } else {
                alert('Error pausing campaign: ' + data.error);
            }
        });
    }
}

function resumeCampaign() {
    if (confirm('Are you sure you want to resume this campaign?')) {
        fetch('{% url "neuro_ads:resume_campaign" campaign.id %}', {
            method: 'POST',
            headers: {
                'X-CSRFToken': '{{ csrf_token }}',
                'Content-Type': 'application/json'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                location.reload();
            } else {
                alert('Error resuming campaign: ' + data.error);
            }
        });
    }
}

function optimizeCampaign() {
    if (confirm('Trigger AI optimization for this campaign? This will analyze performance and make automatic adjustments.')) {
        fetch('{% url "neuro_ads:optimize_campaign" campaign.id %}', {
            method: 'POST',
            headers: {
                'X-CSRFToken': '{{ csrf_token }}',
                'Content-Type': 'application/json'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert('AI optimization triggered successfully! Changes will appear shortly.');
                location.reload();
            } else {
                alert('Error triggering optimization: ' + data.error);
            }
        });
    }
}

function generateNewCreatives() {
    if (confirm('Generate new AI-powered ad creatives for this campaign?')) {
        fetch('{% url "neuro_ads:generate_creatives" campaign.id %}', {
            method: 'POST',
            headers: {
                'X-CSRFToken': '{{ csrf_token }}',
                'Content-Type': 'application/json'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert('New creatives generated successfully!');
                location.reload();
            } else {
                alert('Error generating creatives: ' + data.error);
            }
        });
    }
}

function deleteCampaign() {
    if (confirm('Are you sure you want to delete this campaign? This action cannot be undone.')) {
        fetch('{% url "neuro_ads:delete_campaign" campaign.id %}', {
            method: 'DELETE',
            headers: {
                'X-CSRFToken': '{{ csrf_token }}',
                'Content-Type': 'application/json'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                window.location.href = '{% url "neuro_ads:campaigns" %}';
            } else {
                alert('Error deleting campaign: ' + data.error);
            }
        });
    }
}
</script>
{% endblock %}